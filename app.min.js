document.addEventListener('DOMContentLoaded',()=>{const e=document.getElementById('main-page'),t=document.getElementById('results-page'),n=document.getElementById('main-search-form'),s=document.getElementById('results-search-form'),i=document.getElementById('main-search-input'),a=document.getElementById('results-search-input'),o=document.getElementById('tabs-container'),r=document.getElementById('instant-answer-container'),l=document.getElementById('results-container'),d=document.getElementById('autocomplete-suggestions'),c=document.getElementById('results-suggestions'),m=document.getElementById('theme-checkbox'),u=document.getElementById('source-toggle'),h=document.getElementById('privacy-toggle'),p=document.getElementById('menu-button'),g=document.getElementById('side-menu'),f=document.getElementById('header-logo-home'),y=document.getElementById('menu-home-btn'),v=document.getElementById('back-to-top'),b=document.getElementById('back-to-home'),w=document.getElementById('voice-search-btn'),S=document.getElementById('results-voice-btn'),E=document.getElementById('ai-mode-btn'),I=document.getElementById('results-ai-mode-btn'),x=document.getElementById('ai-chat'),k=document.getElementById('ai-input'),C=document.getElementById('ai-messages'),M=document.getElementById('ai-send'),T=document.getElementById('upload-btn'),L=document.getElementById('results-upload-btn'),P=document.getElementById('image-upload'),A=document.getElementById('date-filter'),B=document.getElementById('location-filter');let q={currentQuery:'',currentPage:1,resultsPerPage:20,isAiMode:!1},D={darkMode:!1,showSource:!1,privacy:!0},F=[],j=[],O;const R=[{name:'Google',baseUrl:'https://www.google.com/search?q=',parser:z},{name:'Bing',baseUrl:'https://www.bing.com/search?q=',parser:H},{name:'DuckDuckGo',baseUrl:'https://duckduckgo.com/?q=',parser:z},{name:'Yahoo',baseUrl:'https://search.yahoo.com/search?p=',parser:H},{name:'Yandex',baseUrl:'https://yandex.com/search/?text=',parser:z},{name:'Ecosia',baseUrl:'https://www.ecosia.org/search?q=',parser:z},{name:'Brave',baseUrl:'https://search.brave.com/search?q=',parser:H},{name:'Startpage',baseUrl:'https://www.startpage.com/sp/search?q=',parser:z},{name:'Mojeek',baseUrl:'https://www.mojeek.com/search?q=',parser:H},{name:'Qwant',baseUrl:'https://www.qwant.com/?q=',parser:z},{name:'Ask',baseUrl:'https://www.ask.com/web?q=',parser:H},{name:'Searx',baseUrl:'https://searx.org/search?q=',parser:z},{name:'MetaGer',baseUrl:'https://metager.org/meta/meta.ger3?eingabe=',parser:H}];if('serviceWorker'in navigator&&navigator.serviceWorker.register('/sw.js').then(()=>console.log('SW registered')),function(){const e=localStorage.getItem('mistaFySettings');e&&(D=JSON.parse(e),document.body.classList.toggle('dark-mode',D.darkMode),m.checked=D.darkMode,u.checked=D.showSource,h.checked=D.privacy)}(),function(){localStorage.setItem('mistaFySettings',JSON.stringify(D))}(),E.onclick=I.onclick=function(){q.isAiMode=!q.isAiMode,x.style.display=q.isAiMode?'block':'none',[E,I].forEach(e=>{const t=e.querySelector('svg');t.innerHTML=q.isAiMode?'<path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zm0 1a6 6 0 1 1 0 12A6 6 0 0 1 8 2zm0 2a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm0 4a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>':'<path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM1.5 8a6.5 6.5 0 1 1 13 0 6.5 6.5 0 0 1-13 0z"/><path d="M6.5 7.75v1.5a.75.75 0 0 0 1.5 0v-1.5a.75.75 0 0 0-1.5 0zm4 0v1.5a.75.75 0 0 0 1.5 0v-1.5a.75.75 0 0 0-1.5 0z"/>',t.style.fill=q.isAiMode?'#b0b0b0':'#666'}),q.isAiMode&&(C.innerHTML='<div class="ai-msg">AI मोड चालू: प्रश्न पूछें!</div>')},M.onclick=async()=>{const e=k.value.trim();if(!e)return;C.innerHTML+='<div class="user-msg">'+e+'</div>',k.value='',C.innerHTML+='<div class="ai-loading">AI सोच रहा है...</div>';const t=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Authorization':'Bearer YOUR_OPENAI_KEY','Content-Type':'application/json'},body:JSON.stringify({model:'gpt-4o-mini',messages:[...F,{role:'user',content:e}]})}),n=await t.json(),s=n.choices[0].message.content;C.innerHTML=C.innerHTML.replace('<div class="ai-loading">AI सोच रहा है...</div>','<div class="ai-msg">'+s+'</div>'),F.push({role:'user',content:e},{role:'assistant',content:s})},[T,L].forEach(e=>e.onclick=()=>P.click()),P.onchange=e=>{const t=e.target.files[0];t&&(q.currentQuery=URL.createObjectURL(t),handleMultimodal(q.currentQuery,'image'))},[A,B].forEach(e=>e.onchange=function(){q.currentQuery+=` ${A.value?`after:${A.value}`:''} ${B.value?`near:${B.value}`:''}`}),n.addEventListener('submit',async e=>{e.preventDefault();const t=e.target===n?i:a;q.currentQuery=t.value.trim(),q.currentQuery&&(applyFilters(),showResultsPage(),[i.value,a.value]=[q.currentQuery,q.currentQuery],r.innerHTML='',l.innerHTML='',o.innerHTML='',c.innerHTML='',q.currentPage=1,await handleInstantAnswers(q.currentQuery)||await fetchAndRenderFullResults())}),s.addEventListener('submit',async e=>{e.preventDefault();const t=e.target===s?a:i;q.currentQuery=t.value.trim(),q.currentQuery&&(applyFilters(),showResultsPage(),[i.value,a.value]=[q.currentQuery,q.currentQuery],r.innerHTML='',l.innerHTML='',o.innerHTML='',c.innerHTML='',q.currentPage=1,await handleInstantAnswers(q.currentQuery)||await fetchAndRenderFullResults())}),m.addEventListener('change',()=>{D.darkMode=m.checked,saveSettings(),loadSettings()}),u.addEventListener('change',()=>{D.showSource=u.checked,saveSettings()}),h.addEventListener('change',()=>{D.privacy=h.checked,saveSettings()}),o.addEventListener('click',e=>{e.target.classList.contains('tab-button')&&(o.querySelector('.active')&&o.querySelector('.active').classList.remove('active'),e.target.classList.add('active'),renderResults(j[e.target.dataset.tab]||j.all,'all'))}),f.addEventListener('click',showMainPage),y.addEventListener('click',showMainPage),p.addEventListener('click',()=>g.classList.toggle('open')),i.addEventListener('input',e=>{clearTimeout(O),O=setTimeout(()=>{fetchAutocomplete(e.target.value)},200)}),document.addEventListener('click',e=>{!g.contains(e.target)&&!p.contains(e.target)&&g.classList.remove('open'),!i.contains(e.target)&&d.style.display==='block'&&(d.style.display='none')}),window.onscroll=()=>{[v,b].forEach(e=>e.style.display=document.documentElement.scrollTop>50?'block':'none')},v.onclick=()=>window.scrollTo({top:0,behavior:'smooth'}),b.onclick=showMainPage;const N=window.SpeechRecognition||window.webkitSpeechRecognition;N?([w,S].forEach(e=>{e.onclick=()=>{const t=e.id==='voice-search-btn'?i:a;N.start(),t.placeholder='बोलें...',N.onresult=e=>{t.value=e.results[0][0].transcript,t.form.requestSubmit()},N.onerror=()=>t.placeholder='सुन नहीं पाया।'}}})):([w,S].forEach(e=>e.style.display='none'));if('/api'===window.location.pathname){const e=new URLSearchParams(window.location.search).get('q');e&&(q.currentQuery=e,fetchAndRenderFullResults(!0).then(t=>{const n={query:e,results:t,timestamp:(new Date).toISOString()};0===j.length&&(n.error='No results'),document.body.innerHTML=JSON.stringify(n)}))}function showResultsPage(){e.style.display='none',t.style.display='block'}function showMainPage(){t.style.display='none',e.style.display='flex',x.style.display='none',q.isAiMode=!1}async function handleInstantAnswers(e){const t=e.toLowerCase();if(/^\d+\s*\*\s*\d+$/.test(t)){const[e,n]=t.split('*').map(Number);return renderInstantAnswer('कैलकुलेटर',`<h3>${e*n}</h3>`),!0}if(/(weather|mausam)\s(in|mein)\s(.+)/.test(t)){const e=t.match(/(weather|mausam)\s(in|mein)\s(.+)/)[3],n=await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${e}&appid=YOUR_WEATHER_API_KEY&units=metric&lang=hi`),s=await n.json();return renderInstantAnswer('मौसम',`<h3>${s.main.temp}°C</h3><p>${s.weather[0].description}</p>`),!0}if(/(\d+)\s(\w+)\sto\s(\w+)/.test(t)){const[e,n,s]=t.match(/(\d+)\s(\w+)\sto\s(\w+)/),i=await fetch(`https://api.exchangerate-api.com/v4/latest/${n}`),a=await i.json(),o=a.rates[s];return renderInstantAnswer('मुद्रा',`<h3>${e} ${n} = ${(e*o).toFixed(2)} ${s}</h3>`),!0}if(/(cricket score|match result)\s(.+)/.test(t)){const e=t.match(/(cricket score|match result)\s(.+)/)[2],n=await fetch(`https://api.cricapi.com/v1/currentMatches?apikey=YOUR_CRICKET_API_KEY`),s=await n.json(),i=s.data.find(t=>t.match.includes(e))?.status||'कोई लाइव मैच नहीं';return renderInstantAnswer('क्रिकेट',`<h3>${i}</h3>`),!0}return!1}function renderInstantAnswer(e,t){r.innerHTML='<div class="widget-card">'+t+'</div>'}async function fetchAndRenderFullResults(e=!1){l.innerHTML='<div class="loader">खोज रहे हैं...</div>';const t=await Promise.allSettled(R.map(e=>fetchAndParse(e,q.currentQuery))).flatMap(e=>'fulfilled'===e.status?e.value:[]);j=t.reduce((e,t)=>(e[t.category||'all'].push(t),e),{all:[],images:[]}),0===j.all.length?(l.innerHTML='<div class="result-item">कोई परिणाम नहीं।</div>',j.all=[]):o.innerHTML='<button class="tab-button active" data-tab="all">सभी</button>'+j.images.length?'<button class="tab-button" data-tab="images">चित्र</button>':'',renderResults(j.all,'all');return e?j.all:[]}function renderResults(e,t){l.innerHTML=e.slice(0,q.currentPage*q.resultsPerPage).map(e=>`<div class="result-item"><a href="${e.link}" target="_blank">${e.title}</a><p>${e.snippet}</p>${D.showSource&&e.source?'<small>स्रोत: '+e.source+'</small>':''}</div>`).join('')}async function fetchAndParse(e,t){const n=`${e.baseUrl}${encodeURIComponent(t)}`,s=await fetchViaProxy(n);return e.parser(s)}async function fetchViaProxy(e){const t=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(e)}`),n=await t.json();return new DOMParser().parseFromString(n.contents,'text/html')}function z(e){return Array.from(e.querySelectorAll('div.g,article.result')).map(e=>{const t=e.querySelector('a'),n=e.querySelector('h3,h2');if(!t||!n)return null;const s=e.querySelector('img')?.src||'';return{title:n.textContent,link:t.href,snippet:e.querySelector('span,p')?.textContent||'',thumbnail:s}}).filter(Boolean)}function H(e){return Array.from(e.querySelectorAll('li.b_algo,div.compilation')).map(e=>{const t=e.querySelector('a'),n=e.querySelector('h2');if(!t||!n)return null;const s=e.querySelector('img')?.src||'';return{title:n.textContent,link:t.href,snippet:e.querySelector('p')?.textContent||'',thumbnail:s}}).filter(Boolean)}async function fetchAutocomplete(e,t=!1){e.length<2?(d.style.display='none',c.innerHTML=''):await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://suggestqueries.google.com/complete/search?client=firefox&q='+encodeURIComponent(e))}`).then(e=>e.json()).then(e=>{const n=JSON.parse(e.contents)[1],s=n.map(e=>`<div class="suggestion-item" onclick="selectSuggestion('${e}')">${e}</div>`).join('');t?c.innerHTML=s:(d.innerHTML=s,d.style.display='block')})}window.selectSuggestion=e=>{i.value=e,a.value=e,handleSearch(new Event('submit'))},async function handleMultimodal(e,t='image'){if('image'===t){const t=await fetchAndParse(R.find(e=>'Google'===e.name),e);renderResults(t,'images')}}window.onscroll=()=>{document.documentElement.scrollTop+window.innerHeight>=document.documentElement.scrollHeight-100&&q.currentPage*j.all.length<100&&fetchMoreResults()};async function fetchMoreResults(){const e=q.currentPage*q.resultsPerPage,t=e+q.resultsPerPage;if(t<=j.all.length){const n=j.all.slice(e,t).map(e=>`<div class="result-item"><a href="${e.link}" target="_blank">${e.title}</a><p>${e.snippet}</p>${D.showSource&&e.source?'<small>स्रोत: '+e.source+'</small>':''}</div>`).join('');l.innerHTML+=n,q.currentPage++}}function applyFilters(){q.currentQuery+=` ${A.value?`after:${A.value}`:''} ${B.value?`near:${B.value}`:''}`},loadSettings()});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(t=>t||fetch(e.request)))});
